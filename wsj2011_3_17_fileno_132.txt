The end of the Raymond Davis saga yesterday infuriated Pakistani Islamist and anti-American groups and created an unfortunate diplomatic precedent. But considering the seven emotionally charged weeks that preceded it, even a messy solution counts as a good outcome.

Pakistani politicians turned a shooting incident involving Mr. Davis, who held diplomatic immunity, into a domestic political firestorm and a major crisis in relations with America. In the end cooler heads prevailed. The military and civilian authorities came together to free Mr. Davis after a "blood money" payment of $2.3 million to the families of the two men he killed.

On January 27, Mr. Davis shot and killed two armed Pakistanis on motorcycles who surrounded his car in central Lahore. He said he acted in self-defense against robbers. Other officials speculated the Pakistanis were Mr. Davis's tail from the powerful military spy agency, Inter-Services Intelligence (ISI). 

Under the Vienna Convention, Mr. Davis should never have been tried. But Pakistan's weak civilian government didn't act quickly to confirm his diplomatic immunity, giving time for public outrage to brew. The U.S. embassy in Islamabad also issued conflicting statements about Mr. Davis's job status.

The true power in Pakistan—the security establishment—had a vested interest in the Davis case. As the U.S. later admitted, the former Army special forces soldier belonged to a secret, CIA-backed team that monitored militants deep in Pakistan. Among those is Lashkar-e-Taiba, the terrorists who organized the November 2008 Mumbai bombings and are based in Lahore.

The Pakistanis have long played a double game, supporting the U.S. and Islamist militants. Parts of the ISI back Lashkar, as well as the Afghan Taliban and other terrorist groups, and they resent the CIA's intrusion on their turf.

In the last two years, Islamabad has helped the U.S. expand drone strikes and other covert operations against militants holed up in the tribal western regions of Pakistan, along the Afghan border. At the same time, Pakistan's government and military have become prominent targets for the terrorists too. Yesterday's deal reflects a recognition of the importance of the strategic relationship with America that has came under so much strain in recent months. 

Called diyat, "blood money" payments to relatives of victims are allowed under Islamic law, in exchange for "pardoning" the accused. According to international law, Mr. Davis should have been released immediately after the January shooting. But in a place like Pakistan, a non-disastrous outcome is often as good as you can hope for.